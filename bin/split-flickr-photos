#! /Users/gwcoffey/.rbenv/shims/ruby

require 'yaml'
require 'fileutils'

ROOT = "content/archive/flickr/murals-of-phoenix"

data = YAML.load(File.read(File.join(ROOT, "data.yml")))
output = {}

data["carousel"].each do |path, photo|
	line = "{{< figure src=\"" + path.gsub("photos/", "") + "\""
	line += " caption=\"" + photo["caption"] + "\"" unless photo["caption"].nil?
	line += " >}}"

	output[photo["title"]] ||= []
	output[photo["title"]] << {line: line, path: path}
end


output.each do |name, lines|
	if name.nil?
		puts "# (NO NAME)"
	else
		puts "# " + name
	end
	lines.each do |line|
		puts line[:line]
	end
	puts
end

puts "Ok to procees? [y/n]:"

if gets.chomp == "y"
	output.each do |name, lines|
		slug = name.downcase.gsub(/[^a-z0-9 ]/, '').gsub(/^ +| +$/, '').gsub(/ +/, '-')
		path = File.join(ROOT, slug)
		FileUtils.mkdir_p path
		lines.each do |line|
			FileUtils.cp File.join(ROOT, line[:path]), File.join(path, line[:path].gsub("photos/", ""))
		end
		
		pre = {
			"title" => name,
			"archive" => "flickr",
			"date" => lines[0][:path].gsub("photos/", "").gsub(/_.*/, "").gsub(/(\d{4})(\d{2})(\d{2})/, '\1-\2-\3'),
			"tags" => ["Photo"]
		}
		
		File.open(File.join(path, "index.md"), "w") do |f|
			f.print YAML.dump(pre)
			f.puts("---")
			lines.each {|line| f.puts line[:line]}
		end
	end
end